(function(f){function N(){this.data={}}function U(){this.listeners=new N}function V(b){setTimeout(function(){throw b;},0)}function J(b){this.type=b;this.target=null}function W(b,a){J.call(this,b);this.data=a.data;this.lastEventId=a.lastEventId}function K(b,a){var e=Number(b)||a;return e<X?X:e>L?L:e}function O(b,a,e){try{"function"===typeof a&&a.call(b,e)}catch(c){V(c)}}function p(b,a){function e(){m=C;null!==d&&(d.abort(),d=null);0!==h&&(clearTimeout(h),h=0);0!==D&&(clearTimeout(D),D=0);n.readyState=C}function c(b){var a=m===z||m===v?d.responseText||"":"",g=null,c=!1;if(m===v){var g=0,f="",l="";if(E)try{g=Number(d.status||0),f=String(d.statusText||""),l=String(d.getResponseHeader("Content-Type")||"")}catch(R){g=0}else g=200,l=d.contentType;if(200===g&&ca.test(l)){if(m=z,F=!0,s=A,n.readyState=z,g=new J("open"),n.dispatchEvent(g),O(n,n.onopen,g),m===C)return}else if(0!==g){var u="EventSource's response has a status "+g+" "+f.replace(/\s+/g,"")+". Reconnecting.";-1===[305,401,407,302,303,307,500,502,503,504].indexOf(d.status)&&(u=200!==g?"EventSource's response has a status "+g+" "+f.replace(/\s+/g," ")+" that is not 200. Aborting the connection.":"EventSource's response has a Content-Type specifying an unsupported type: "+l.replace(/\s+/g," ")+". Aborting the connection.",c=!0);setTimeout(function(){throw Error(u);})}}if(m===z){a.length>G&&(F=!0);for(var f=G-1,l=a.length,r="\n";++f<l;)if(r=a[f],k===P&&"\n"===r)k=w;else if(k===P&&(k=w),"\r"===r||"\n"===r){"data"===t?H.push(q):"id"===t?M=q:"event"===t?x=q:"retry"===t?s=A=K(q,A):"heartbeatTimeout"===t&&(I=K(q,I),0!==h&&(clearTimeout(h),h=setTimeout(y,I)));t=q="";if(k===w){if(0!==H.length&&(p=M,""===x&&(x="message"),g=new W(x,{data:H.join("\n"),lastEventId:M}),n.dispatchEvent(g),"message"===x&&O(n,n.onmessage,g),m===C))return;H.length=0;x=""}k="\r"===r?P:w}else k===w&&(k=Y),k===Y?":"===r?k=Z:t+=r:k===Z?(" "!==r&&(q+=r),k=$):k===$&&(q+=r);G=l}m!==z&&m!==v||!(b||c||1048576<G||0===h&&!F)?0===h&&(F=!1,h=setTimeout(y,I)):(m=Q,d.abort(),0!==h&&(clearTimeout(h),h=0),s>16*A&&(s=16*A),s>L&&(s=L),c?e():h=setTimeout(y,s),s=2*s+1,n.readyState=v,g=new J("error"),n.dispatchEvent(g),O(n,n.onerror,g))}function l(){c(!1)}function R(){c(!0)}b=String(b);var u=Boolean(S&&a&&a.withCredentials),A=K(a?a.retry:NaN,1E3),I=K(a?a.heartbeatTimeout:NaN,45E3),p=a&&a.lastEventId&&String(a.lastEventId)||"",n=this,s=A,F=!1,d=new aa,B=a?a.header?a.header:{}:{},h=0,D=0,G=0,m=Q,H=[],M="",x="",y=null,k=w,t="",q="";a=null;E&&(D=setTimeout(function ba(){3===d.readyState&&l();D=setTimeout(ba,500)},0));y=function(){h=0;if(m!==Q)c(!1);else if(E&&(void 0!==d.sendAsBinary||void 0===d.onloadend)&&f.document&&f.document.readyState&&"complete"!==f.document.readyState)h=setTimeout(y,4);else{d.onload=d.onerror=R;E&&(d.onabort=R,d.onreadystatechange=l);d.onprogress=l;F=!1;h=setTimeout(y,I);G=0;m=v;H.length=0;x="";M=p;t=q="";k=w;var a=b.slice(0,5),a="data:"!==a&&"blob:"!==a?b+((-1===b.indexOf("?",0)?"?":"&")+"lastEventId="+encodeURIComponent(p)+"&r="+String(Math.random()+1).slice(2)):b;d.open("GET",a,!0);E&&(d.withCredentials=u,d.responseType="text",d.setRequestHeader("Accept","text/event-stream"),Object.keys(B).forEach(function(a){d.setRequestHeader(a,B[a])}));d.send(null)}};this.listeners=new N;this.close=e;this.url=b;this.readyState=v;this.withCredentials=u;this.onerror=this.onmessage=this.onopen=null;y()}function B(){this.CONNECTING=v;this.OPEN=z;this.CLOSED=C}N.prototype={get:function(b){return this.data[b+"~"]},set:function(b,a){this.data[b+"~"]=a},"delete":function(b){delete this.data[b+"~"]}};U.prototype={dispatchEvent:function(b){b.target=this;var a=this.listeners.get(String(b.type));if(a)for(var e=a.length,c=-1,l=null;++c<e;){l=a[c];try{l.call(this,b)}catch(f){V(f)}}},addEventListener:function(b,a){b=String(b);var e=this.listeners,c=e.get(b);c||(c=[],e.set(b,c));for(e=c.length;0<=--e;)if(c[e]===a)return;c.push(a)},removeEventListener:function(b,a){b=String(b);var e=this.listeners,c=e.get(b);if(c){for(var f=c.length,p=[],u=-1;++u<f;)c[u]!==a&&p.push(c[u]);if(0===p.length)e["delete"](b);else e.set(b,p)}}};W.prototype=J.prototype;var T=f.XMLHttpRequest,da=f.XDomainRequest,S=Boolean(T&&void 0!==(new T).withCredentials),E=S,aa=S?T:da,Q=-1,v=0,z=1,C=2,P=3,w=4,Y=5,Z=6,$=7,ca=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i,X=1E3,L=18E6;B.prototype=U.prototype;p.prototype=new B;B.call(p);aa&&(f.NativeEventSource=f.EventSource,f.EventSource=p)})(this);
